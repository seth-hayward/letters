@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"> 
    <title>letters to crushes chat</title>

    <link rel="icon" type="image/png" href="favicon.ico" />

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>

    <link href="@Url.Content("~/Content/chat.css")?20130714" rel="stylesheet">


    <script type="text/javascript" src="@Url.Content("~/Scripts/jquery-layout/jquery-ui-1.9.2.min.js")"></script>
	<script type="text/javascript" src="@Url.Content("~/Scripts/jquery-layout/jquery.layout-1.3.0.js")"></script>
    <link type="text/css" rel="stylesheet" href="@Url.Content("~/Scripts/jquery-layout/layout-default-latest.css")" />
	
    <script src="@Url.Content("/Scripts/jquery.signalR-1.0.1.min.js")" type="text/javascript"></script>

    <script src="~/signalr/hubs" type="text/javascript"></script>

    <script type="text/javascript">

        console.log("mylayout initalized.");
        var myLayout;


        $(function () {
            myLayout = $('body').layout({

                //	reference only - these options are NOT required because 'true' is the default
                closable: true	// pane can open & close
                , resizable: true	// when open, pane can be resized 
                , slidable: true	// when closed, pane can 'slide' open over other panes - closes on mouse-out
                , livePaneResizing: true

                                //	some resizing/toggling settings
                , north__slidable: false	// OVERRIDE the pane-default of 'slidable=true'
                , north__togglerLength_closed: '100%'	// toggle-button is full-width of resizer-bar
                , north__spacing_closed: 10		// big resizer-bar when open (zero height)
                , north__minSize: 200
                , north__showOverflowOnHover: false
                , north__onopen_start: function () {
                    console.log("onopen_start");
                    $("#chat_history").load("@Url.Content("~/chat/history")");
                }
                , north__initClosed: true
                , center__showOverflowOnHover: false
                , south__initHidden: true



                                //	enable state management
                , stateManagement__enabled: false // automatic cookie load & save enabled by default

                , showDebugMessages: false // log and/or display messages from debugging & testing code
            });



            Date.prototype.addHours = function(h) {    
                this.setTime(this.getTime() + (h*60*60*1000)); 
                return this;   
            }

            String.prototype.toDate = function () {
                "use strict";

                var match = /\/Date\((\d{13})\)\//.exec(this);

                return match === null ? null : new Date(parseInt(match[1], 10));
            };

            //used to keep the most recent messages visible
            function scrollDown(loading) {
                if (loading == true) { return; }

                $("#chat_container").animate({ scrollTop: $("#log").height() + 100 }, 10);

                $("#entry").focus();
            }

            var chat;

            var messsage_counter = 0;

            // first we want to get the user's name
            // before we make the chat client

            function updateMessage(message, loading) {
                var output_message = '<table class="message"><tr>';
                
                var chat_date = message.ChatDate;

                output_message += '  <td class="date">' + dateFormat(chat_date, "h:MM TT") + '</td>';
                output_message += '  <td valign="top" class="nick">' + message.Nick + '</td>';
                output_message += '  <td class="msg-txt">' + message.Message + '</td>'
                output_message += '</tr></table>'
                $("#log").append(output_message);
                scrollDown(loading);
            }

            function updatePageTitle() {

                if (message_counter >= 1) {
                    document.title = "(" + message_counter + ") letters to crushes chat";
                } else {
                    document.title = "letters to crushes chat";
                }

            }

            function joinChat() {

                // Proxy created on the fly          
                chat = $.connection.chat;                

                // Declare a function on the chat hub so the server can invoke it          
                chat.client.addMessage = function (message) {

                    // handle a special case where we want to 
                    // reset the history when we join a new chat
                    if (message.Room == "reset-channel") {
                        $("#log").empty();
                        return;
                    }

                    updateMessage(message, false);

                    message_counter++;
                    updatePageTitle();

                };

                // Declare a function on the chat hub so the server can invoke it          
                chat.client.addBacklog = function (messages) {
                    for (var i = 0; i < messages.length; i++) {
                        updateMessage(messages[i], true);
                    }

                    scrollDown(false);
                };

                chat.client.errorMessage = function (message) {
                    $("#name").show();
                    $("#log").hide();
                    alert(message);

                    // reload the page, force the user to login again
                    location.reload();
                };

                chat.client.enterChat = function (message) {
                    $("#name").hide();
                    $("#log").show();
                    $("#toolbar").show();
                    myLayout.show("south");
                    message_counter = 0;
                };

                $.connection.hub.stateChanged(function (change) {

                    var date_now = new Date();
                    var reconnecting = false;

                    var message = {
                        Message: change.newState,
                        Nick: "Server",
                        ChatDate: date_now,
                        Publish: 1,
                    };

                    if (change.newState === $.signalR.connectionState.reconnecting) {
                        message.Message = "RECONNECTING... chat server reboot. Sorry!";
                        reconnecting = true;
                    }
                    else if (change.newState === $.signalR.connectionState.disconnected) {
                        message.Message = "Disconnected.";
                    }
                    else if (change.newState === $.signalR.connectionState.connecting) {
                        message.Message = "Connecting.";
                        message.Publish = 0;
                    }
                    else if (change.newState === $.signalR.connectionState.connected) {
                        message.Message = "Connected.";
                        message.Publish = 0;

                        if (reconnecting == true) {
                            chat.server.send(" -- reconnected.");
                        } else {
                            chat.server.join($("#chat_name").val());
                        }

                        reconnecting = false;

                    }

                    if (message.Publish === 1) {
                        updateMessage(message);
                    };

                });

                // Start the connection
                $.connection.hub.start().done(function () {

                    $('#entry').keydown(function (e) {
                        if (e.keyCode == 13) {


                            var chat_message = $("#entry").val();

                            if (chat_message == "/history") {
                                myLayout.show("north");
                                $("#chat_history").load("@Url.Content("~/chat/history")");
                                $("#entry").val("");
                                return;
                            }

                            chat.server.send($('#entry').val());
                            $("#entry").val("");
                            message_counter = -1;

                            updatePageTitle();
                            e.preventDefault();
                        }
                    })

                    $("#broadcast").click(function () {


                        var chat_message = $("#entry").val();

                        if (chat_message == "/history") {
                            $("#chat_history").load("@Url.Content("~/chat/history")");
                            $("#entry").val("");
                            return;
                        }

                        // Call the chat method on the server
                        chat.server.send($('#entry').val());
                        $("#entry").val("");
                        message_counter = -1;
                        updatePageTitle();
                    });
                });

                event.preventDefault();

            }



            $('#chat_name').keydown(function (e) {

                console.log("chat_name keydown");


                if ($('#chat_name').val().length == 0) {
                    return;
                }

                if (e.keyCode == 13) {
                    joinChat();
                    e.preventDefault();
                    return false;
                }
            })

            $("#join").click(function () {

                console.log("join click");


                if ($('#chat_name').val().length == 0) {
                    return;
                }

                joinChat();               
            });

        });

        /*
         * Date Format 1.2.3
         * (c) 2007-2009 Steven Levithan <stevenlevithan.com>
         * MIT license
         *
         * Includes enhancements by Scott Trenda <scott.trenda.net>
         * and Kris Kowal <cixar.com/~kris.kowal/>
         *
         * Accepts a date, a mask, or a date and a mask.
         * Returns a formatted version of the given date.
         * The date defaults to the current date/time.
         * The mask defaults to dateFormat.masks.default.
         */

        var dateFormat = function () {
            var token = /d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,
                timezone = /\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,
                timezoneClip = /[^-+\dA-Z]/g,
                pad = function (val, len) {
                    val = String(val);
                    len = len || 2;
                    while (val.length < len) val = "0" + val;
                    return val;
                };

            // Regexes and supporting functions are cached through closure
            return function (date, mask, utc) {
                var dF = dateFormat;

                // You can't provide utc if you skip other args (use the "UTC:" mask prefix)
                if (arguments.length == 1 && Object.prototype.toString.call(date) == "[object String]" && !/\d/.test(date)) {
                    mask = date;
                    date = undefined;
                }

                // Passing date through Date applies Date.parse, if necessary
                date = date ? new Date(date) : new Date;
                if (isNaN(date)) throw SyntaxError("invalid date");

                mask = String(dF.masks[mask] || mask || dF.masks["default"]);

                // Allow setting the utc argument via the mask
                if (mask.slice(0, 4) == "UTC:") {
                    mask = mask.slice(4);
                    utc = true;
                }

                var _ = utc ? "getUTC" : "get",
                    d = date[_ + "Date"](),
                    D = date[_ + "Day"](),
                    m = date[_ + "Month"](),
                    y = date[_ + "FullYear"](),
                    H = date[_ + "Hours"](),
                    M = date[_ + "Minutes"](),
                    s = date[_ + "Seconds"](),
                    L = date[_ + "Milliseconds"](),
                    o = utc ? 0 : date.getTimezoneOffset(),
                    flags = {
                        d: d,
                        dd: pad(d),
                        ddd: dF.i18n.dayNames[D],
                        dddd: dF.i18n.dayNames[D + 7],
                        m: m + 1,
                        mm: pad(m + 1),
                        mmm: dF.i18n.monthNames[m],
                        mmmm: dF.i18n.monthNames[m + 12],
                        yy: String(y).slice(2),
                        yyyy: y,
                        h: H % 12 || 12,
                        hh: pad(H % 12 || 12),
                        H: H,
                        HH: pad(H),
                        M: M,
                        MM: pad(M),
                        s: s,
                        ss: pad(s),
                        l: pad(L, 3),
                        L: pad(L > 99 ? Math.round(L / 10) : L),
                        t: H < 12 ? "a" : "p",
                        tt: H < 12 ? "am" : "pm",
                        T: H < 12 ? "A" : "P",
                        TT: H < 12 ? "AM" : "PM",
                        Z: utc ? "UTC" : (String(date).match(timezone) || [""]).pop().replace(timezoneClip, ""),
                        o: (o > 0 ? "-" : "+") + pad(Math.floor(Math.abs(o) / 60) * 100 + Math.abs(o) % 60, 4),
                        S: ["th", "st", "nd", "rd"][d % 10 > 3 ? 0 : (d % 100 - d % 10 != 10) * d % 10]
                    };

                return mask.replace(token, function ($0) {
                    return $0 in flags ? flags[$0] : $0.slice(1, $0.length - 1);
                });
            };
        }();

        // Some common format strings
        dateFormat.masks = {
            "default": "ddd mmm dd yyyy HH:MM:ss",
            shortDate: "m/d/yy",
            mediumDate: "mmm d, yyyy",
            longDate: "mmmm d, yyyy",
            fullDate: "dddd, mmmm d, yyyy",
            shortTime: "h:MM TT",
            mediumTime: "h:MM:ss TT",
            longTime: "h:MM:ss TT Z",
            isoDate: "yyyy-mm-dd",
            isoTime: "HH:MM:ss",
            isoDateTime: "yyyy-mm-dd'T'HH:MM:ss",
            isoUtcDateTime: "UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"
        };

        // Internationalization strings
        dateFormat.i18n = {
            dayNames: [
                "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat",
                "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"
            ],
            monthNames: [
                "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec",
                "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"
            ]
        };

        // For convenience...
        Date.prototype.format = function (mask, utc) {
            return dateFormat(this, mask, utc);
        };
    </script>
  
</head>
<body>

    @{
        if(User.Identity.IsAuthenticated == true) {
          
            <text>

    
                <div id="chat_history" class="ui-layout-north" >


                </div>



                <div id="chat_container" data-role="page" class="ui-layout-center">

	                <div data-role="content">	

                        <div id="app">

                            <div id="name">        
                                <label for="chat_name">name</label>
                                <input id="chat_name" class="text" type="text" name="nick" value=""/>                        
                                <input type="button" id="join" value="join chat"/>                                
                             </div>
             

                            <div id="loading" style="display: none">
                                <p>loading</p>
                            </div>
            
                            <div id="log" style="display: none;">

                            </div>

                            <div id="ending_point">

                            </div>
                                                   
                        </div>

	                </div><!-- /content -->


                </div><!-- /page -->

                <div class="ui-layout-south" id="toolbar" >    
                    <table style="width: 100%;">
                        <tr>
                            <td style="text-align: center">
                                <input tabindex="1" id="entry" type="text" />
                            </td>
                        </tr>

                    </table>
                </div>

    
            </text>         
    }
    
        else {
            
            <text>

                <div class="ui-layout-center">

                    <div id="please_login">

                        <h3>
                            Please <a href="http://www.letterstocrushes.com/login">login</a> or <a href="http://letterstocrushes.com/Account/Register" alt="register">create an account</a> to chat.
                        </h3>

                        <p>Also, don't be a troll.</p>

                    </div>


                </div>
                                
                </text>    
         }
                          
        }
                    


    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-459727-11");
        pageTracker._trackPageview();
    } catch (err) { }</script>

</body>
</html>